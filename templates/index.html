<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einsatzleitung</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ last_updated }}">
</head>

<body>
    <!-- Welcome Screen (shown when no active shift) -->
    <div id="welcome-screen" class="welcome-screen">
        <div class="welcome-left">
            <div class="welcome-content">
                <p class="welcome-copywrite">Ein Projekt von Noah Elvis Oberkofler und Moritz Schelten</p>
                <h1>Johanniter<br>Mission Control</h1>
                <p class="welcome-subtitle">Einsatzleitung & Protokollierung</p>

                <div class="welcome-actions">
                    <button class="btn-welcome-primary" onclick="openShiftSetup()">

                        Neuer Dienst
                    </button>
                    <button class="btn-welcome-secondary" onclick="openTutorial()">

                        Tutorial
                    </button>
                </div>

            </div>
        </div>
        <div class="welcome-right">
            <img src="/static/welcome-image.jpg" alt="Johanniter" class="welcome-image">
        </div>
    </div>

    <!-- Shift Setup Modal (opened from welcome screen) -->
    <div id="shift-setup-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Dienst konfigurieren</h2>
                <button class="close-btn" onclick="closeModal('shift-setup-modal')">&times;</button>
            </div>
            <form id="shift-setup-form" onsubmit="startShift(event)">
                <div class="form-group">
                    <label>Name des Dienstes / Einsatzort (Optional)</label>
                    <input type="text" id="conf-location" placeholder="z.B. Stadtfest">
                </div>
                <div class="form-group">
                    <label>Adresse (Optional)</label>
                    <input type="text" id="conf-address" placeholder="Musterstra√üe 1">
                </div>
                <div class="form-group">
                    <label>Dienstbeginn (Optional)</label>
                    <input type="datetime-local" id="conf-start">
                    <small>Leer lassen f√ºr "Jetzt"</small>
                </div>

                <div class="form-group">
                    <label>Anzahl initialer Trupps</label>
                    <div class="number-control">
                        <div class="btn-counter" onclick="changeSquadCount(-1)">-</div>
                        <input type="number" id="conf-squad-count" min="0" max="20" value="0" readonly>
                        <div class="btn-counter" onclick="changeSquadCount(1)">+</div>
                    </div>
                    <div id="squad-inputs-container" class="squad-inputs-grid"></div>
                </div>

                <div style="text-align: right;">
                    <button type="submit" class="btn-primary">Dienst starten</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorial-modal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2>Tutorial - Mission Control</h2>
                <button class="close-btn" onclick="closeModal('tutorial-modal')">&times;</button>
            </div>
            <div class="tutorial-body">
                <!-- Slide 1: Welcome -->
                <div class="tutorial-slide active" data-step="0">
                    <h3>Willkommen bei Johanniter Mission Control</h3>
                    <p>Diese Anwendung unterst√ºtzt Sie bei der digitalen Einsatzleitung und Protokollierung.</p>
                    <div class="tutorial-feature-list">
                        <div class="feature-item">
                            <span class="feature-icon">üöÄ</span>
                            <strong>Dienst starten</strong>
                            <p>Konfigurieren Sie Einsatzort und initiale Ressourcen.</p>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üë•</span>
                            <strong>Trupps verwalten</strong>
                            <p>Status per Klick √§ndern, neue Trupps hinzuf√ºgen.</p>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üìù</span>
                            <strong>Eins√§tze</strong>
                            <p>Vollst√§ndige Dokumentation von Alarmierung bis Abschluss.</p>
                        </div>
                    </div>
                </div>

                <!-- Slide 2: Squads -->
                <div class="tutorial-slide" data-step="1">
                    <h3>Trupp-Verwaltung</h3>
                    <p>Behalten Sie den √úberblick √ºber alle Einheiten.</p>
                    <ul>
                        <li><strong>Status √§ndern:</strong> Klicken Sie direkt auf die Buttons (EB, BO, AO, ...).</li>
                        <li><strong>Timer:</strong> Sehen Sie sofort, wie lange ein Trupp schon im aktuellen Status ist.
                        </li>
                        <li><strong>Bearbeiten:</strong> Nutzen Sie das Stift-Symbol ‚úé beim Trupp, um Besatzung oder
                            Qualifikation zu √§ndern.</li>
                        <li><strong>Sortieren:</strong> Verschieben Sie Trupps per Drag & Drop, um die Reihenfolge
                            anzupassen.</li>
                    </ul>
                    <div class="tutorial-tip">
                        üí° <strong>Tipp:</strong> Sie k√∂nnen jederzeit neue Trupps √ºber das <strong>+</strong> Symbol in
                        der Trupp-Leiste hinzuf√ºgen.
                    </div>
                </div>

                <!-- Slide 3: Missions -->
                <div class="tutorial-slide" data-step="2">
                    <h3>Einsatz-Erfassung</h3>
                    <p>Erstellen Sie neue Eins√§tze √ºber <strong>+ Neuer Einsatz</strong>.</p>
                    <ul>
                        <li><strong>Zuordnung:</strong> W√§hlen Sie beteiligte Trupps direkt aus.</li>
                        <li><strong>Drag & Drop:</strong> Ziehen Sie einen Trupp auf einen offenen Einsatz, um ihn
                            direkt zuzuweisen.</li>
                        <li><strong>Live-Status:</strong> Der Status der Trupps wird im Einsatz angezeigt.</li>
                        <li><strong>Abschluss:</strong> Wenn ein Einsatz beendet ist, w√§hlen Sie einen Ausgang (z.B.
                            "Belassen").</li>
                    </ul>
                </div>

                <!-- Slide 4: Protocol & Export -->
                <div class="tutorial-slide" data-step="3">
                    <h3>Protokoll & Export</h3>
                    <p>Alles wird im Hintergrund mitgeschrieben.</p>
                    <ul>
                        <li><strong>Protokoll:</strong> Klicken Sie auf "Protokoll", um den gesamten Verlauf zu sehen.
                        </li>
                        <li><strong>√Ñnderungen:</strong> Das Ticker-Band unten zeigt immer die letzte Aktivit√§t.</li>
                        <li><strong>Export:</strong> Nutzen Sie "Exportieren", um eine Textdatei f√ºr Ihre Ablage zu
                            generieren.</li>
                    </ul>
                </div>
            </div>

            <div class="tutorial-footer">
                <div class="step-dots">
                    <span class="dot active"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
                <div class="tutorial-buttons">
                    <button id="btn-tut-prev" class="btn-secondary" onclick="prevTutorialStep()"
                        disabled>Zur√ºck</button>
                    <button id="btn-tut-next" class="btn-primary" onclick="nextTutorialStep()">Weiter</button>
                </div>
            </div>
        </div>
    </div>

    <header>
        <div class="header-left">
            <div class="header-title-row">
                <h1>Einsatzleitung</h1>
                <button id="btn-config" class="icon-btn header-icon-btn" onclick="openConfigModal()"
                    title="Dienst bearbeiten">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                </button>
                <button id="btn-help" class="icon-btn header-icon-btn" onclick="openTutorial()"
                    title="Hilfe / Tutorial">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </button>
                <button id="btn-theme-toggle" class="icon-btn header-icon-btn" onclick="toggleTheme()"
                    title="Dark/Light Mode">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <button id="btn-color-picker" class="icon-btn header-icon-btn"
                    onclick="document.getElementById('theme-color-input').click()" title="Farbe √§ndern">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="13.5" cy="6.5" r=".5"></circle>
                        <circle cx="17.5" cy="10.5" r=".5"></circle>
                        <circle cx="8.5" cy="7.5" r=".5"></circle>
                        <circle cx="6.5" cy="12.5" r=".5"></circle>
                        <path
                            d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.063 0-1.125.75-2.062 1.688-2.062H18c2.25 0 4-1.75 4-4V8c0-5.5-4.5-6-10-6z">
                        </path>
                    </svg>
                </button>
                <input type="color" id="theme-color-input" style="display:none;" onchange="setHeaderColor(this.value)">
            </div>
            <span id="shift-location" class="subtitle"></span>
        </div>

        <div class="header-center">
            <div class="time-container">
                <div id="clock" class="clock">--:--:--</div>
                <div id="date" class="date">--.--.----</div>
            </div>
            <div id="weather-widget" class="weather-widget hidden">
                <span id="weather-icon" class="weather-icon"></span>
                <span id="weather-temp" class="weather-temp">--¬∞C</span>
            </div>
        </div>

        <div class="header-actions">
            <button id="btn-log" onclick="openLogModal()">Protokoll</button>
            <button id="btn-export" onclick="window.location.href='/api/export'">Exportieren</button>
            <button id="btn-end-shift" onclick="endShift()" class="btn-danger">Dienst beenden</button>
        </div>
    </header>

    <main>
        <!-- Squad Panel -->
        <section class="squad-panel">
            <div class="panel-header">
                <span>Trupp-√úbersicht</span>
                <button class="btn-gray" onclick="openSquadModal()">+ Neuer Trupp</button>
            </div>
            <div id="squad-list" class="squad-list">
                <!-- Squads loaded here -->
            </div>
        </section>

        <!-- Mission Panel -->
        <section class="mission-panel">
            <div class="panel-header" id="mission-panel-header">
                <span>Einsatztagebuch <span id="mission-stats"></span></span>
                <button class="btn-gray" onclick="openNewMissionModal()">+ Neuer Einsatz</button>
            </div>
            <div id="mission-list" class="mission-list">
                <!-- Missions loaded here -->
            </div>
        </section>
    </main>

    <!-- Logs / Ticker Bar -->
    <footer id="ticker-bar">
        <span>Letzte √Ñnderung: <span id="last-log">...</span></span>
        <span class="ticker-copyright">&copy; Noah Elvis Oberkofler & Moritz Schelten</span>
    </footer>

    <!-- New Mission Modal -->
    <div id="new-mission-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="mission-modal-title">Neuer Einsatz</h2>
                <button class="close-btn" onclick="closeModal('new-mission-modal')">&times;</button>
            </div>
            <form id="new-mission-form" onsubmit="submitMission(event)">
                <input type="hidden" id="edit-mission-id">

                <div class="row">
                    <div class="form-group half">
                        <label>Einsatznummer (Optional)</label>
                        <input type="text" id="m-number">
                    </div>
                </div>

                <div class="form-group">
                    <label>Einsatzort</label>
                    <input type="text" id="m-location" list="list-location" required>
                    <datalist id="list-location"></datalist>
                </div>

                <div class="form-group">
                    <label>Alarmierende Stelle</label>
                    <input type="text" id="m-entity" list="list-entity">
                    <datalist id="list-entity"></datalist>
                </div>

                <div class="form-group">
                    <label>Zugeordnete Trupps</label>
                    <div id="m-squad-select" class="checkbox-group">
                        <!-- Checkboxes injected by JS -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Berufungsgrund</label>
                    <input type="text" id="m-reason" list="list-reason" required>
                    <datalist id="list-reason"></datalist>
                </div>

                <div class="form-group">
                    <label>Lagebeschreibung (Optional)</label>
                    <textarea id="m-desc" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label>Anmerkungen</label>
                    <textarea id="m-notes" rows="2"></textarea>
                </div>

                <div class="form-group" id="outcome-group" style="display:none;">
                    <label>Ausgang des Einsatzes <span style="color:red;">*</span></label>
                    <select id="m-outcome" onchange="toggleEditArmFields()">
                        <option value="">-- Bitte w√§hlen --</option>
                        <option value="Intervention unterblieben">Intervention unterblieben</option>
                        <option value="Belassen">Belassen (vor Ort belassen)</option>
                        <option value="ARM">ARM (Anderes Rettungsmittel)</option>
                        <option value="PVW">PVW (Patient verweigert)</option>
                    </select>

                    <div id="m-arm-fields"
                        style="display:none; background: #f9f9f9; padding: 1rem; border-radius: 4px; margin-top: 1rem; border: 1px solid #eee;">
                        <div style="display: flex; gap: 1rem;">
                            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                <input type="text" id="m-arm-type" placeholder="Typ (z.B. RTW)">
                            </div>
                            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                <input type="text" id="m-arm-id" placeholder="Kennung (z.B. 12/83-1)">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-danger" id="btn-delete-mission" onclick="openDeleteMissionModal()"
                        style="display:none;">L√∂schen</button>
                    <!-- Cancel Removed -->
                    <button type="button" class="btn-success" id="btn-complete-mission" onclick="completeMission()"
                        style="display:none;">Abschlie√üen</button>
                    <button type="submit" class="btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-mission-modal" class="modal">
        <div class="modal-content small" style="text-align: center;">
            <div class="modal-header">
                <h2>Einsatz L√∂schen</h2>
                <button class="close-btn" onclick="closeModal('delete-mission-modal')">&times;</button>
            </div>
            <p>Bitte geben Sie einen Grund f√ºr das L√∂schen an:</p>
            <textarea id="delete-mission-reason" rows="3" style="width: 100%; margin-bottom: 1rem;"
                placeholder="Begr√ºndung..."></textarea>
            <div class="modal-footer" style="justify-content: center;">
                <!-- Cancel Removed -->
                <button class="btn-danger" onclick="confirmDeleteMission()">Endg√ºltig L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Squad Modal -->
    <div id="squad-modal" class="modal">
        <div class="modal-content small">
            <div class="modal-header">
                <h2 id="squad-modal-title">Neuer Trupp</h2>
                <button class="close-btn" onclick="closeModal('squad-modal')">&times;</button>
            </div>
            <form id="s-form" onsubmit="submitSquad(event)">
                <input type="hidden" id="s-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="s-name" required>
                </div>
                <div class="form-group">
                    <label>Qualifikation</label>
                    <input type="text" id="s-qual" placeholder="San, RS, NFS...">
                </div>
                <div class="modal-footer">
                    <button type="button" id="btn-delete-squad" class="btn-danger" onclick="deleteSquad()"
                        style="display:none;">L√∂schen</button>
                    <!-- Cancel Removed -->
                    <button type="submit" class="btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Log Viewer Modal -->
    <div id="log-modal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2>Protokoll</h2>
                <button class="close-btn" onclick="closeModal('log-modal')">&times;</button>
            </div>
            <div class="log-container">
                <table id="log-table">
                    <thead>
                        <tr>
                            <th>Zeit</th>
                            <th>Aktion</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Logs here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Config Edit Modal -->
    <div id="config-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Dienst bearbeiten</h2>
                <button class="close-btn" onclick="closeModal('config-modal')">&times;</button>
            </div>
            <form onsubmit="updateConfig(event)">
                <div class="form-group">
                    <label>Name des Dienstes / Einsatzort</label>
                    <input type="text" id="edit-conf-location">
                </div>
                <div class="form-group">
                    <label>Adresse</label>
                    <input type="text" id="edit-conf-address">
                </div>
                <div class="row">
                    <div class="form-group half">
                        <label>Dienstbeginn</label>
                        <input type="datetime-local" id="edit-conf-start">
                    </div>
                    <div class="form-group half">
                        <label>Dienstende</label>
                        <input type="datetime-local" id="edit-conf-end">
                    </div>
                </div>

                <div class="form-group">
                    <label>Einsatzorte importieren (Optional)</label>
                    <input type="file" id="locations-file" accept=".txt">
                    <small>Plain-Text-Datei mit einem Ort pro Zeile</small>
                </div>

                <div class="modal-footer">
                    <!-- Cancel Removed -->
                    <button type="submit" class="btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEB Confirmation Modal -->
    <div id="neb-confirm-modal" class="modal">
        <div class="modal-content small" style="text-align: center;">
            <div class="modal-header">
                <h2>Trupp ist im Einsatz</h2>
                <button class="close-btn" onclick="closeModal('neb-confirm-modal')">&times;</button>
            </div>
            <p id="neb-confirm-text">Der Trupp ist aktuell einem Einsatz zugewiesen.</p>
            <div class="modal-footer"
                style="justify-content: center; flex-direction: column; gap: 0.5rem; align-items: center;">
                <button class="btn-success" style="width: 100%; padding: 0.4rem; font-size: 0.9rem;"
                    onclick="resolveNebConflict('remove')">Aus Einsatz entfernen & NEB setzen</button>
                <button class="btn-primary" style="width: 100%; padding: 0.4rem; font-size: 0.9rem;"
                    onclick="resolveNebConflict('keep')">Im Einsatz behalten & NEB setzen</button>
            </div>
        </div>
    </div>

    <!-- Complete Mission Modal -->
    <div id="complete-mission-modal" class="modal">
        <div class="modal-content small">
            <div class="modal-header">
                <h2>Einsatz abschlie√üen</h2>
                <button class="close-btn" onclick="closeModal('complete-mission-modal')">&times;</button>
            </div>
            <input type="hidden" id="complete-mission-id">
            <div class="form-group">
                <label>Ausgang des Einsatzes <span style="color:red;">*</span></label>
                <select id="complete-mission-outcome" onchange="toggleArmFields()">
                    <option value="">-- Bitte w√§hlen --</option>
                    <option value="Intervention unterblieben">Intervention unterblieben</option>
                    <option value="Belassen">Belassen (vor Ort belassen)</option>
                    <option value="ARM">ARM (Anderes Rettungsmittel)</option>
                    <option value="PVW">PVW (Patient verweigert)</option>
                </select>
            </div>

            <div id="arm-fields"
                style="display:none; background: #f9f9f9; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; border: 1px solid #eee;">
                <div style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <input type="text" id="arm-type" placeholder="Typ (z.B. RTW)">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <input type="text" id="arm-id" placeholder="Kennung (z.B. 12/83-1)">
                    </div>
                </div>
            </div>

            <div class="modal-footer" style="justify-content: flex-end;">
                <!-- Cancel Removed -->
                <button class="btn-success" onclick="submitCompletion()">Abschlie√üen</button>
            </div>
        </div>
    </div>

    <div id="guide-overlay" class="guide-overlay"></div>
    <script src="{{ url_for('static', filename='script.js') }}?v=FORCE_RELOAD_999"></script>
    <script>
        // Inline Weather Script for maximum reliability

        // Global Coords
        window.weatherLat = 52.52;
        window.weatherLon = 13.41;

        async function fetchWeather() {
            const widget = document.getElementById('weather-widget');

            // Unhide
            if (widget) widget.classList.remove('hidden');

            let lat = window.weatherLat;
            let lon = window.weatherLon;

            // Geolocation
            if (navigator.geolocation) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                    });
                    lat = position.coords.latitude;
                    lon = position.coords.longitude;

                    // Update global
                    window.weatherLat = lat;
                    window.weatherLon = lon;
                } catch (e) {
                    console.log("Geo error:", e);
                }
            }

            // Fetch
            try {
                // Add timestamp to prevent caching
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto&_=${new Date().getTime()}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error("HTTP " + response.status);

                const data = await response.json();

                if (data.current_weather) {
                    const temp = Math.round(data.current_weather.temperature);
                    const code = data.current_weather.weathercode;
                    const isDay = data.current_weather.is_day; // 1=Day, 0=Night

                    let icon = '‚ùì';
                    const getIcon = (d, n) => isDay === 1 ? d : n;

                    if (code === 0) icon = getIcon('‚òÄÔ∏è', 'üåô');
                    else if (code === 1) icon = getIcon('üå§Ô∏è', 'üåô');
                    else if (code === 2) icon = getIcon('‚õÖ', 'üåô'); // Partly cloudy (Moon)
                    else if (code === 3) icon = '‚òÅÔ∏è';
                    else if (code === 45 || code === 48) icon = 'üå´Ô∏è';
                    else if (code >= 51 && code <= 67) icon = 'üåßÔ∏è';
                    else if (code >= 71 && code <= 77) icon = 'üå®Ô∏è';
                    else if (code >= 80 && code <= 82) icon = 'üå¶Ô∏è';
                    else if (code >= 85 && code <= 86) icon = '‚ùÑÔ∏è';
                    else if (code >= 95) icon = '‚õàÔ∏è';

                    const iconEl = document.getElementById('weather-icon');
                    const tempEl = document.getElementById('weather-temp');

                    if (iconEl) iconEl.textContent = icon;
                    if (tempEl) tempEl.textContent = temp + "¬∞C";

                    console.log(`Weather: ${icon} ${temp}C`);
                }
            } catch (err) {
                console.error(err);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchWeather();

            // Meteoblue Link
            const widget = document.getElementById('weather-widget');
            if (widget) {
                widget.onclick = () => {
                    const url = `https://www.meteoblue.com/en/weather/week/index?lat=${window.weatherLat}&lon=${window.weatherLon}`;
                    window.open(url, '_blank');
                };
            }
        });
    </script>
</body>

</html>